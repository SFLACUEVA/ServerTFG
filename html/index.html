<!-- SPDX-License-Identifier: GPL-2.0-or-later -->
<!DOCTYPE html>
<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

<link rel="stylesheet" href="index.css">

<body>
    <h1>Battery charge monitoring station</h1>

    <div id="divMenu">
        <button id="btRefresh" onclick="refresca()">Refrescar lista!</button>
        <button id="btConsulta" onclick="consulta()">Consultar!</button>
        <button id="btDescargar" onclick="descargar()">Descargar!</button>
        <select name="Selector" id="selTab">
        </select>
    </div>
    <div id="tablas">

        <div class="tabla">
            <p class="txt">Resumen global</p>
            <table id="tableSumG"></table>
        </div>
        <div class="tabla">
            <p class="txt">Resumen seleccion</p>
            <table id="tableSumS"></table>
        </div>
    </div>

    <div id="divChart" style="width:100%;max-width:1000px">
        <canvas id="myChart"></canvas>
    </div>
    <table class="tabla" id="tableT"></table>

    <script>

        var valCSV;

        class magnitud {
            constructor(nombre, unidad) {
                this.nombre = nombre;
                this.unidad = unidad;
            }
        }

        var magnitudes = [];
        magnitudes.push(new magnitud("Temperature", "C"));
        magnitudes.push(new magnitud("Current", "A"));
        magnitudes.push(new magnitud("Voltage", "V"));

        var speedCanvas = document.getElementById("myChart");
        var lineChart = new Chart(speedCanvas, {
            type: 'line'
        });

        var arrSummary = new Array();
        refresca();
       


        function getMax(input) {
            var out = input[0];

            for (let i = 0; i < input.length; i++) {
                if (out < input[i]) {
                    out = input[i];
                }

            }
            return out;
        }

        function getMin(input) {
            var out = input[0];

            for (let i = 0; i < input.length; i++) {
                if (out > input[i]) {
                    out = input[i];
                }

            }
            return out;
        }

        function MAX() {
            let mag = document.getElementById("selMed").value;
            let num = document.getElementById("selCant").value;
            const rqMax = new XMLHttpRequest();
            rqMax.onload = function () {
                respuesta = this.responseText;

                arrSummary.push(respuesta);


            }
            rqMax.open("GET", "accesoDB.php?t=u&m=" + mag + "&c=" + num);
            rqMax.send();


        }

        function refresca() {
            
            tables = []
            const getTables = new XMLHttpRequest();
            getTables.onload = function () {
                respuesta = this.responseText;
                tables = respuesta.split("|");
                tables.pop();
                console.log(tables);
                let selTab = document.getElementById("selTab");
                
                for (let i = 0; i < tables.length; i++) {
                    const opt = document.createElement('option');
                    opt.value = tables[i];
                    opt.text = tables[i];
                    selTab.add(opt);
                }

            }
            getTables.open("GET", "measures.php?f=t");
            getTables.send();


        }

        function consulta() {
            let val = [];
            let tabla = document.getElementById("selTab").value;
            console.log(typeof tabla)
            const getVal = new XMLHttpRequest();
            getVal.onload = function () {
                respuesta = this.responseText;
                valores = toArray(respuesta);
                console.log(valores)
                getSum(valores,tabla);
            }
            getVal.open("GET", "measures.php?f=v&t="+tabla);
            getVal.send();


        }

        function getSum(valores,tabla){
            const getsum = new XMLHttpRequest();
            getsum.onload = function () {
                respuesta = this.responseText;
                console.log(respuesta)
            }
            getsum.open("GET", "measures.php?f=s&t="+tabla);
            getsum.send();
        }

        function toArray(texto) {

            var rows = texto.split("#");
            var celda = [];
            rows.pop()
            for (let i = 0; i < rows.length; i++) {

                celda.push(rows[i].split("|"));
            }
            /*
            let prim = table.insertRow(0);
            let cell3 = prim.insertCell(0);
            cell3.innerHTML = "Fecha";

            cell3 = prim.insertCell(0);
            cell3.innerHTML = "Valor";

            cell3 = prim.insertCell(0);
            cell3.innerHTML = "ID_Sens";
            cell3 = prim.insertCell(0);
            cell3.innerHTML = "ID_Med";
            */

            return celda;

        }
        
        function updateGraph(datos) {
            //console.table(datos);

            valCSV = datos;

            var sel = document.getElementById("selCant");
            var sel2 = document.getElementById("selMed").value;

            switch (sel2) {
                case "t":
                    sel2 = 0;
                    break;

                case "h":
                    sel2 = 1;
                    break;

                case "c":
                    sel2 = 2;
                    break;

                case "p":
                    sel2 = 3;
                    break;

                default:
                // code block
            }

            var cant = Number(sel.value);
            var trunc = 1;
            var pad = 0.1;
            var step = 2;
            var magnitud = magnitudes[sel2].nombre;
            var unidad = magnitudes[sel2].unidad;

            console.log("grafico actulizado");
            var xValues = [];
            var yValues = [];
            for (var i = 0; i < datos.length; i++) {
                xValues.push(datos[i][3]);
                yValues.push(Number(datos[i][2]));
            }
            let avg = getAvg(yValues);
            var max = getMax(yValues);
            var min = getMin(yValues);
            var margen = 0.1 * (max - min);
            var arriba = max + margen;
            var abajo = min - margen;

            arriba = Math.ceil(arriba / trunc) * trunc;
            abajo = Math.floor(abajo / trunc) * trunc;


            var medidas = {
                label: magnitud,
                data: yValues,
                lineTension: 0.2,
                fill: false,
                borderColor: 'grey'
            };

            var arrMax = [];
            var arrMin = [];
            var arrAvg = [];
            for (let i = 0; i < yValues.length; i++) {
                arrMax.push(max);
                arrMin.push(min);
                arrAvg.push(avg);
            }



            var avgD = {
                label: "Media",
                data: arrAvg,
                lineTension: 0,
                fill: false,
                backgroundColor: "rgba(0,0,0,0)",
                borderWidth: 3,
                pointBackgroundColor: "rgba(0,0,0,0)",
                pointRadius: 0,

                pointHoverRadius: 0,
                borderColor: "rgba(100,100,100,0.3)"
            };


            var maxD = {
                label: "Maximo",
                data: arrMax,
                lineTension: 0,
                fill: false,
                backgroundColor: "rgba(0,0,0,0)",
                borderWidth: 3,
                pointBackgroundColor: "rgba(0,0,0,0)",
                pointRadius: 0,
                pointHoverRadius: 0,
                borderColor: "rgba(255,0,0,0.3)"
            };

            var minD = {
                label: "Minimo",
                data: arrMin,
                lineTension: 0,
                fill: false,
                backgroundColor: "rgba(0,0,0,0)",
                borderWidth: 3,
                pointBackgroundColor: "rgba(0,0,0,0)",
                pointRadius: 0,
                pointHoverRadius: 0,
                borderColor: "rgba(0,0,255,0.3)"
            };

            var speedData = {
                labels: xValues,
                datasets: [medidas, maxD, minD, avgD]
            };

            var chartOptions = {
                scales: {
                    yAxes: [{
                        ticks: {
                            min: abajo, max: arriba, stepSize: trunc / step, callback: (val) => {
                                return val + unidad;
                            }
                        }
                    }]
                }
            };


            var speedCanvas = document.getElementById("myChart");
            lineChart.options = chartOptions;
            lineChart.data = speedData;
            lineChart.update();

            //actualizar tabla seleccion


            let tabSumEl = ["Max:", "Avg:", "Min:", "Start:", "End:"];
            let tResumen = document.getElementById("tableSumS");
            tResumen.innerHTML = "";
            let cosas = [];
            cosas.push(max.toString() + magnitudes[sel2].unidad);
            cosas.push(avg.toString() + magnitudes[sel2].unidad);
            cosas.push(min.toString() + magnitudes[sel2].unidad);
            cosas.push(xValues[0]);
            cosas.push(xValues[xValues.length - 1]);
            //console.log(cosas);



            let indice = tResumen.insertRow(0);
            for (let i = 0; i < tabSumEl.length; i++) {

                let indice = tResumen.insertRow(i);

                let cellindex = indice.insertCell(0);
                cellindex.innerHTML = tabSumEl[i];

                cellindex = indice.insertCell(-1);
                cellindex.innerHTML = cosas[i];

            }





        }

        function descargar() {


            //consulta();

            const csvContent = "data:text/csv;charset=utf-8," + valCSV.map(row => row.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            let s1 = document.getElementById("selCant").value;
            let s2 = document.getElementById("selMed").value;
            console.log(s1, s2);
            let name = "informe_" + s2 + "_" + s1 + ".csv";
            link.setAttribute("download", name);
            document.body.appendChild(link);
            link.click(); // This will download the CSV file named "products.csv". 
            link.remove();



        }

    </script>

</body>

</html>